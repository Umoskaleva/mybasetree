<!--<!DOCTYPE html>-->
<!--<html xmlns:th="http://www.thymeleaf.org">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1">-->
<!--    <title>Добавить человека</title>-->

<!--    &lt;!&ndash; Подключение Bootstrap CSS &ndash;&gt;-->
<!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">-->
<!--    &lt;!&ndash; Подключение иконок Bootstrap (опционально) &ndash;&gt;-->
<!--    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">-->

<!--    &lt;!&ndash; Подключаем свой CSS (если нужен) &ndash;&gt;-->
<!--    <link rel="stylesheet" th:href="@{/css/style.css}">-->
<!--</head>-->
<!--<body>-->

<!--<div class="container mt-5">-->
<!--    <div class="row justify-content-center">-->
<!--        <div class="col-md-8 col-lg-6">-->
<!--            <h1 class="mb-4">Добавление нового человека</h1>-->

<!--            &lt;!&ndash; Форма отправляет POST запрос на /people/add &ndash;&gt;-->
<!--            <form th:action="@{/people/add}" th:object="${person}" method="post" class="needs-validation">-->

<!--                &lt;!&ndash; Имя &ndash;&gt;-->
<!--                <div class="mb-3">-->
<!--                    <label for="firstName" class="form-label">Имя:</label>-->
<!--                    <input type="text" id="firstName" th:field="*{firstName}" class="form-control" placeholder="Введите имя" required />-->
<!--                </div>-->

<!--                &lt;!&ndash; Фамилия &ndash;&gt;-->
<!--                <div class="mb-3">-->
<!--                    <label for="lastName" class="form-label">Фамилия:</label>-->
<!--                    <input type="text" id="lastName" th:field="*{lastName}" class="form-control" placeholder="Введите фамилию" required />-->
<!--                </div>-->

<!--                &lt;!&ndash; Дата рождения &ndash;&gt;-->
<!--                <div class="mb-3">-->
<!--                    <label for="birthDate" class="form-label">Дата рождения:</label>-->
<!--                    <input type="date" id="birthDate" th:field="*{birthDate}" class="form-control" />-->
<!--                </div>-->

<!--                &lt;!&ndash; Пол &ndash;&gt;-->
<!--                <div class="mb-3">-->
<!--                    <label for="gender" class="form-label">Пол:</label>-->
<!--                    <select id="gender" th:field="*{gender}" class="form-select">-->
<!--                        <option value="" disabled selected>Выберите пол</option>-->
<!--                        &lt;!&ndash; T(com.mybasetree.entity.Gender) позволяет обратиться к Enum напрямую &ndash;&gt;-->
<!--                        <option th:each="genderOpt : ${T(com.mybasetree.entity.Gender).values()}"-->
<!--                                th:value="${genderOpt}"-->
<!--                                th:text="${genderOpt}"></option>-->
<!--                    </select>-->
<!--                </div>-->

<!--                <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">-->
<!--                    <button type="submit" class="btn btn-primary px-4">Сохранить</button>-->
<!--                    <a th:href="@{/tree}" class="btn btn-secondary px-4">Вернуться к дереву</a>-->
<!--                </div>-->
<!--            </form>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->

<!--&lt;!&ndash; Подключение Bootstrap JS (необходимо для работы некоторых компонентов, например выпадающих меню) &ndash;&gt;-->
<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>-->

<!--</body>-->
<!--</html>-->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Добавить человека</title>

    <!-- Подключение Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Подключение иконок Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        .upload-section {
            border: 2px dashed #6c757d;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f8f9fa;
        }
        .upload-section:hover {
            border-color: #0d6efd;
            background-color: #e9ecef;
        }
        .upload-section.dragover {
            border-color: #0d6efd;
            background-color: #cfe2ff;
        }
        .file-info {
            background-color: #f8f9fa;
            border-left: 4px solid #20c997;
            padding: 15px;
            margin-top: 15px;
        }
        .format-badge {
            font-size: 0.8rem;
            padding: 5px 10px;
            margin-right: 5px;
        }
        .progress {
            height: 25px;
            margin-top: 10px;
        }
        .preview-table {
            font-size: 0.9rem;
        }
        .preview-table th {
            background-color: #f8f9fa;
        }
        .tab-content {
            padding: 20px 0;
        }
    </style>
</head>
<body>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <!-- Сообщения -->
            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i>
                <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span th:text="${errorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <h1 class="mb-4">
                <i class="bi bi-person-plus me-2"></i> Добавление людей
            </h1>

            <!-- Навигация по вкладкам -->
            <ul class="nav nav-tabs" id="addPersonTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="single-tab" data-bs-toggle="tab"
                            data-bs-target="#single" type="button" role="tab">
                        <i class="bi bi-person-fill me-1"></i> Один человек
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="file-tab" data-bs-toggle="tab"
                            data-bs-target="#file" type="button" role="tab">
                        <i class="bi bi-file-earmark-arrow-up me-1"></i> Из файла
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="addPersonTabsContent">

                <!-- Вкладка 1: Добавление одного человека -->
                <div class="tab-pane fade show active" id="single" role="tabpanel">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title mb-4">Добавить нового человека</h5>
                            <!-- Форма отправляет POST на /people/add, а этот метод обрабатывает POST по /add-good -->

                            <form th:action="@{/add-good}" th:object="${person}" method="post" class="needs-validation">
                                <div class="row">
<!--                                    <div class="col-md-6 mb-3">-->
<!--                                        <label for="id" class="form-label">Номер *</label>-->
<!--                                        <input type="text" id="id" th:field="*{id}"-->
<!--                                               class="form-control" placeholder="Введите номер записи" required />-->
<!--                                    </div>-->
                                    <div class="col-md-6 mb-3">
                                        <label for="firstName" class="form-label">Имя *</label>
                                        <input type="text" id="firstName" th:field="*{firstName}"
                                               class="form-control" placeholder="Введите имя" required />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="lastName" class="form-label">Фамилия *</label>
                                        <input type="text" id="lastName" th:field="*{lastName}"
                                               class="form-control" placeholder="Введите фамилию" required />
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="surName" class="form-label">Отчество</label>
                                        <input type="text" id="surName" th:field="*{surName}"
                                               class="form-control" placeholder="Введите отчество" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="nickName" class="form-label">Прозвище</label>
                                        <input type="text" id="nickName" th:field="*{nickName}"
                                               class="form-control" placeholder="Введите прозвище" />
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label for="dateOfBirth" class="form-label">Дата рождения</label>
                                        <input type="date" id="dateOfBirth" th:field="*{dateOfBirth}"
                                               class="form-control" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="dateOfMarriage" class="form-label">Дата брака</label>
                                        <input type="date" id="dateOfMarriage" th:field="*{dateOfMarriage}"
                                               class="form-control" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="dateOfDivorce" class="form-label">Дата развода</label>
                                        <input type="date" id="dateOfDivorce" th:field="*{dateOfDivorce}"
                                               class="form-control" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="dateOfDeath" class="form-label">Дата смерти</label>
                                        <input type="date" id="dateOfDeath" th:field="*{dateOfDeath}"
                                               class="form-control" />
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="gender" class="form-label">Пол</label>
                                        <select id="gender" th:field="*{gender}" class="form-select">
                                            <option value="" disabled selected>Выберите пол</option>
                                            <option th:each="genderOpt : ${T(com.mybasetree.entity.Gender).values()}"
                                                    th:value="${genderOpt}"
                                                    th:text="${genderOpt}"></option>
                                        </select>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label for="maidenName" class="form-label">Девичья фамилия</label>
                                        <input type="text" id="maidenName" th:field="*{maidenName}"
                                               class="form-control" placeholder="Для женщин" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="interestingFact" class="form-label">Интересные факты</label>
                                    <textarea id="interestingFact" th:field="*{interestingFact}"
                                              class="form-control" rows="3"
                                              placeholder="Дополнительная информация..."></textarea>
                                </div>

                                <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                                    <button type="submit" class="btn btn-primary px-4">
                                        <i class="bi bi-save me-2"></i> Сохранить человека
                                    </button>
                                    <a th:href="@{/tree}" class="btn btn-secondary px-4">
                                        <i class="bi bi-arrow-left me-2"></i> Вернуться к дереву
                                    </a>

                                    <!--ссылка th:href="@{/add-good}" делает GET-запрос на /add-good -->
<!--                                    <a th:href="@{/add-good}" class="btn btn-secondary px-4">-->
<!--                                        <i class="bi bi-arrow-left me-2"></i>-->
<!--                                    </a>-->
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Вкладка 2: Загрузка из файла -->
                <div class="tab-pane fade" id="file" role="tabpanel">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title mb-4">
                                <i class="bi bi-file-earmark-arrow-up me-2"></i> Загрузка из файла
                            </h5>

                            <div class="mb-4">
                                <h6>Поддерживаемые форматы:</h6>
                                <div class="mb-3">
                                    <span class="badge bg-success format-badge">CSV</span>
                                    <span class="badge bg-primary format-badge">Excel (XLS/XLSX)</span>
                                    <span class="badge bg-info format-badge">JSON</span>
                                </div>

                                <div class="file-info">
                                    <p class="mb-1">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>Требования к файлу:</strong>
                                    </p>
                                    <ul class="small mb-0">
                                        <li>CSV: разделитель - запятая, кодировка UTF-8</li>
                                        <li>Excel: поддерживаются форматы .xls и .xlsx</li>
                                        <li>JSON: массив объектов с полями person</li>
                                        <li>Максимальный размер: 10MB</li>
                                    </ul>
                                </div>

                                <div class="file-info mt-3">
                                    <p class="mb-1">
                                        <i class="bi bi-table me-2"></i>
                                        <strong>Структура данных (пример CSV):</strong>
                                    </p>
                                    <code class="small">
                                        firstName,lastName,surName,birthDate,gender,maidenName,interestingFact<br>
                                        Иван,Иванов,Иванович,1990-01-01,MALE,,Любит путешествовать<br>
                                        Мария,Петрова,Сергеевна,1992-05-15,FEMALE,Иванова,Художница
                                    </code>
                                    <div class="mt-2">
                                        <a th:href="@{/people/download-template}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-download me-1"></i> Скачать шаблон CSV
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Форма загрузки файла -->
                            <form th:action="@{/people/upload-file}" method="post"
                                  enctype="multipart/form-data" id="uploadForm">

                                <!-- Область для перетаскивания файла -->
                                <div class="upload-section mb-3" id="dropArea"
                                     onclick="document.getElementById('fileInput').click()">
                                    <i class="bi bi-cloud-arrow-up display-4 text-primary mb-3"></i>
                                    <h5>Перетащите файл сюда или нажмите для выбора</h5>
                                    <p class="text-muted">Поддерживаются CSV, Excel, JSON</p>
                                    <input type="file" id="fileInput" name="file"
                                           accept=".csv,.xls,.xlsx,.json" style="display: none;"
                                           onchange="handleFileSelect(this)">
                                </div>

                                <!-- Информация о выбранном файле -->
                                <div id="selectedFile" class="d-none mb-3">
                                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-file-earmark me-2"></i>
                                            <strong id="fileName"></strong>
                                            <small class="text-muted ms-2" id="fileSize"></small>
                                        </div>
                                        <button type="button" class="btn-close" onclick="clearFile()"></button>
                                    </div>
                                </div>

                                <!-- Настройки импорта -->
                                <div class="row mb-4">
                                    <div class="col-md-6 mb-3">
                                        <label for="fileType" class="form-label">Тип файла:</label>
                                        <select id="fileType" name="fileType" class="form-select">
                                            <option value="AUTO">Автоопределение</option>
                                            <option value="CSV">CSV</option>
                                            <option value="EXCEL">Excel</option>
                                            <option value="JSON">JSON</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label for="duplicateAction" class="form-label">При дубликатах:</label>
                                        <select id="duplicateAction" name="duplicateAction" class="form-select">
                                            <option value="SKIP">Пропустить</option>
                                            <option value="UPDATE">Обновить</option>
                                            <option value="CREATE_NEW">Создать новый</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Кнопки -->
                                <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                                    <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>
                                        <i class="bi bi-upload me-2"></i> Загрузить файл
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearFile()">
                                        <i class="bi bi-x-circle me-2"></i> Отменить
                                    </button>
                                </div>

                                <!-- Прогресс бар (скрыт по умолчанию) -->
                                <div class="progress mt-3 d-none" id="progressBar">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                                         role="progressbar" style="width: 0%"></div>
                                </div>

                                <!-- Предпросмотр данных -->
                                <div id="previewSection" class="mt-4 d-none">
                                    <h6>Предпросмотр данных:</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm preview-table">
                                            <thead id="previewHeader"></thead>
                                            <tbody id="previewBody"></tbody>
                                        </table>
                                    </div>
                                    <p class="text-muted small" id="previewInfo"></p>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Подключение Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Обработка выбора файла
    function handleFileSelect(input) {
        if (input.files.length > 0) {
            const file = input.files[0];

            // Показать информацию о файле
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatBytes(file.size);
            document.getElementById('selectedFile').classList.remove('d-none');
            document.getElementById('uploadBtn').disabled = false;

            // Автоопределение типа файла
            if (file.name.endsWith('.csv')) {
                document.getElementById('fileType').value = 'CSV';
            } else if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) {
                document.getElementById('fileType').value = 'EXCEL';
            } else if (file.name.endsWith('.json')) {
                document.getElementById('fileType').value = 'JSON';
            }

            // Предпросмотр файла
            previewFile(file);
        }
    }

    // Очистка выбранного файла
    function clearFile() {
        document.getElementById('fileInput').value = '';
        document.getElementById('selectedFile').classList.add('d-none');
        document.getElementById('previewSection').classList.add('d-none');
        document.getElementById('uploadBtn').disabled = true;
        document.getElementById('dropArea').classList.remove('dragover');
    }

    // Форматирование размера файла
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // Drag and drop
    const dropArea = document.getElementById('dropArea');

    dropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropArea.classList.add('dragover');
    });

    dropArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropArea.classList.remove('dragover');
    });

    dropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dropArea.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            document.getElementById('fileInput').files = files;
            handleFileSelect(document.getElementById('fileInput'));
        }
    });

    // Предпросмотр файла
    function previewFile(file) {
        const reader = new FileReader();

        reader.onload = function(e) {
            const content = e.target.result;
            const fileName = file.name.toLowerCase();

            try {
                if (fileName.endsWith('.csv')) {
                    previewCSV(content);
                } else if (fileName.endsWith('.json')) {
                    previewJSON(content);
                } else {
                    // Для Excel файлов просто показываем имя файла
                    document.getElementById('previewSection').classList.remove('d-none');
                    document.getElementById('previewInfo').textContent =
                        'Excel файл. Предпросмотр доступен после загрузки.';
                }
            } catch (error) {
                console.error('Ошибка предпросмотра:', error);
            }
        };

        if (fileName.endsWith('.csv') || fileName.endsWith('.json')) {
            reader.readAsText(file);
        }
    }

    // Предпросмотр CSV
    function previewCSV(content) {
        const lines = content.split('\n').slice(0, 6); // Первые 6 строк
        const previewSection = document.getElementById('previewSection');
        const previewHeader = document.getElementById('previewHeader');
        const previewBody = document.getElementById('previewBody');
        const previewInfo = document.getElementById('previewInfo');

        previewSection.classList.remove('d-none');
        previewHeader.innerHTML = '';
        previewBody.innerHTML = '';

        if (lines.length > 0) {
            // Заголовки
            const headers = lines[0].split(',');
            let headerRow = '<tr>';
            headers.forEach(header => {
                headerRow += `<th>${header.trim()}</th>`;
            });
            headerRow += '</tr>';
            previewHeader.innerHTML = headerRow;

            // Данные
            for (let i = 1; i < Math.min(lines.length, 6); i++) {
                if (lines[i].trim()) {
                    const cells = lines[i].split(',');
                    let row = '<tr>';
                    cells.forEach(cell => {
                        row += `<td>${cell.trim()}</td>`;
                    });
                    row += '</tr>';
                    previewBody.innerHTML += row;
                }
            }

            previewInfo.textContent = `Показано ${Math.min(lines.length - 1, 5)} из примерно ${lines.length - 1} строк`;
        }
    }

    // Предпросмотр JSON
    function previewJSON(content) {
        try {
            const data = JSON.parse(content);
            const previewSection = document.getElementById('previewSection');
            const previewHeader = document.getElementById('previewHeader');
            const previewBody = document.getElementById('previewBody');
            const previewInfo = document.getElementById('previewInfo');

            previewSection.classList.remove('d-none');
            previewHeader.innerHTML = '';
            previewBody.innerHTML = '';

            if (Array.isArray(data) && data.length > 0) {
                // Определяем заголовки из первого объекта
                const firstItem = data[0];
                const headers = Object.keys(firstItem);

                let headerRow = '<tr>';
                headers.forEach(header => {
                    headerRow += `<th>${header}</th>`;
                });
                headerRow += '</tr>';
                previewHeader.innerHTML = headerRow;

                // Данные
                for (let i = 0; i < Math.min(data.length, 5); i++) {
                    let row = '<tr>';
                    headers.forEach(header => {
                        const value = data[i][header];
                        row += `<td>${value !== null && value !== undefined ? value : ''}</td>`;
                    });
                    row += '</tr>';
                    previewBody.innerHTML += row;
                }

                previewInfo.textContent = `Показано ${Math.min(data.length, 5)} из ${data.length} записей`;
            }
        } catch (error) {
            console.error('Ошибка парсинга JSON:', error);
        }
    }

    // Обработка отправки формы загрузки
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        const uploadBtn = document.getElementById('uploadBtn');
        const progressBar = document.getElementById('progressBar');

        // Показать прогресс бар
        progressBar.classList.remove('d-none');

        // Анимировать прогресс
        let width = 0;
        const interval = setInterval(() => {
            if (width >= 90) {
                clearInterval(interval);
            } else {
                width += 10;
                progressBar.querySelector('.progress-bar').style.width = width + '%';
            }
        }, 500);

        // Блокировать кнопку
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i> Загрузка...';
    });
</script>
</body>
</html>
